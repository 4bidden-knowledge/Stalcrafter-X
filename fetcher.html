<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stalcraft Price Checker</title>
  <style>
    body { background:#1a1a1a; color:#e0e0e0; font-family:sans-serif; padding:20px; }
    input, button { padding:8px; margin:5px; border-radius:6px; border:none; }
    input { width:200px; }
    button { background:#444; color:#fff; cursor:pointer; }
    button:hover { background:#666; }
    pre { background:#222; padding:12px; border-radius:6px; overflow-x:auto; }
  </style>
</head>
<body>
  <h2>Stalcraft Auction Price Checker</h2>
  <input type="text" id="itemId" placeholder="Enter Item ID (e.g. wokd)">
  <button onclick="fetchItem()">Check</button>
  <pre id="output">Results will appear here…</pre>

  <script>
    const REGION = "na";

    async function fetchHistory(id) {
      const url = `https://stalcraftdb.net/api/items/${id}/auction-history?region=${REGION}&page=0`;
      const headers = {
        "User-Agent": "Mozilla/5.0",
        "Accept": "application/json",
        "Referer": `https://stalcraftdb.net/${REGION}/${id}`
      };
      const resp = await fetch(url, { headers });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    function computeStats(raw, days) {
      if (!Array.isArray(raw)) return null;
      const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
      const trades = raw
        .filter(p => new Date(p.time).getTime() >= cutoff)
        .map(p => ({
          unitPrice: p.price / p.amount,
          amount: p.amount
        }))
        .filter(p => Number.isFinite(p.unitPrice) && p.amount > 0);

      if (trades.length === 0) return null;

      const totalUnits = trades.reduce((s, t) => s + t.amount, 0);
      const weightedSum = trades.reduce((s, t) => s + t.unitPrice * t.amount, 0);
      const mean = trades.reduce((s, t) => s + t.unitPrice, 0) / trades.length;
      const min = Math.min(...trades.map(t => t.unitPrice));
      const max = Math.max(...trades.map(t => t.unitPrice));

      return {
        weightedAvg: Math.round(weightedSum / totalUnits),
        mean: Math.round(mean),
        sampleCount: trades.length,
        min: Math.round(min),
        max: Math.round(max)
      };
    }

    async function fetchItem() {
      const id = document.getElementById("itemId").value.trim();
      if (!id) return;
      const output = document.getElementById("output");
      output.textContent = "Loading…";
      try {
        const raw = await fetchHistory(id);
        const data = raw.prices || raw;
        const stats24h = computeStats(data, 1);
        const stats7d = computeStats(data, 7);

        const result = {
          id,
          region: REGION,
          updated: new Date().toISOString(),
          stats24h,
          stats7d
        };
        output.textContent = JSON.stringify(result, null, 2);
      } catch (err) {
        output.textContent = "Error: " + err.message;
      }
    }
  </script>
</body>
</html>
