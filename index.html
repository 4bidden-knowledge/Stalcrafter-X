<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stalcraft Crafting Calculator</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px;color:#0b1220}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0}
  .grid{display:grid;gap:12px;grid-template-columns:1fr;max-width:980px}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  table{width:100%;border-collapse:collapse}
  td,th{padding:8px;border-bottom:1px solid #eee;text-align:left}
  input[type=number]{width:100px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:#666;font-size:13px}
  .right{margin-left:auto}
  .big{font-size:1.05rem;font-weight:600}
  footer{margin-top:18px;color:#666;font-size:13px}
  @media(min-width:800px){ .grid{grid-template-columns:1fr 360px} }
</style>
</head>
<body>
<header>
  <h1>Stalcraft — Crafting Calculator</h1>
  <div class="muted">Reads <code>prices.json</code> from the same folder</div>
</header>

<main class="grid">
  <div class="card">
    <div class="row">
      <div>
        <label class="muted">Tools markup (%):</label><br/>
        <input id="toolsMarkup" type="range" min="5" max="10" step="0.5" value="7.5">
        <span id="markupVal">7.5%</span>
      </div>
      <div class="right">
        <button id="refreshBtn">Refresh prices</button>
      </div>
    </div>

    <p class="muted">If 24h average is missing the UI will fallback to 7-day average.</p>

    <table id="itemsTable">
      <thead>
        <tr><th>Item</th><th>Unit (24h / 7d)</th><th>Qty</th><th>Per-unit (used)</th><th>Cost</th><th>Premium equiv</th></tr>
      </thead>
      <tbody>
        <!-- rows generated by JS -->
      </tbody>
      <tfoot>
        <tr>
          <th colspan="4" class="right">TOTAL</th>
          <th id="totalCost" class="big">—</th>
          <th id="totalPremium" class="big">—</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <h3>Notes & quick controls</h3>
    <p class="muted">This calculator uses your repo's <code>prices.json</code>. If values are missing or stale, update your fetcher and CSV job.</p>
    <div style="margin-top:8px">
      <button id="use24Btn">Prefer 24h</button>
      <button id="use7Btn">Prefer 7d</button>
    </div>

    <h4 style="margin-top:12px">Legend</h4>
    <ul class="muted">
      <li><strong>Advanced</strong> divisor = 800</li>
      <li><strong>Standard</strong> divisor = 600</li>
      <li><strong>Cheap</strong> divisor = 400</li>
      <li>Tools markup applies to tools before dividing for premium currency.</li>
    </ul>
  </div>
</main>

<footer class="muted">Drop this file next to <code>prices.json</code>. If you host with GitHub Pages, use your Pages URL.</footer>

<script>
(async function(){
  // config: names + key mapping to JSON
  const ITEMS = [
    { key: "adv_spare", label: "Advanced spare", type: "spare", tier: "advanced", divisor: 800 },
    { key: "std_spare", label: "Standard spare", type: "spare", tier: "standard", divisor: 600 },
    { key: "cheap_spare", label: "Cheap spare", type: "spare", tier: "cheap", divisor: 400 },
    { key: "adv_tool", label: "Advanced tool", type: "tool", tier: "advanced", divisor: 800 },
    { key: "std_tool", label: "Standard tool", type: "tool", tier: "standard", divisor: 600 },
    { key: "cheap_tool", label: "Cheap tool", type: "tool", tier: "cheap", divisor: 400 }
  ];

  const tableBody = document.querySelector("#itemsTable tbody");
  const totalCostEl = document.getElementById("totalCost");
  const totalPremiumEl = document.getElementById("totalPremium");
  const markupInput = document.getElementById("toolsMarkup");
  const markupVal = document.getElementById("markupVal");
  const refreshBtn = document.getElementById("refreshBtn");
  const use24Btn = document.getElementById("use24Btn");
  const use7Btn = document.getElementById("use7Btn");

  let PRICE_DATA = {}; // filled from prices.json
  let prefer = "24"; // "24" or "7"

  markupInput.addEventListener("input", ()=> markupVal.textContent = markupInput.value + "%");
  refreshBtn.addEventListener("click", loadAndRender);
  use24Btn.addEventListener("click", ()=> { prefer="24"; renderRows(); });
  use7Btn.addEventListener("click", ()=> { prefer="7"; renderRows(); });

  // create rows
  for(const it of ITEMS){
    const tr = document.createElement("tr");
    tr.dataset.key = it.key;
    tr.innerHTML = `
      <td><strong>${it.label}</strong><div class="muted">${it.key}</div></td>
      <td id="${it.key}-units" class="muted">—</td>
      <td><input id="${it.key}-qty" type="number" min="0" value="0"></td>
      <td id="${it.key}-unitUsed" class="muted">—</td>
      <td id="${it.key}-cost">—</td>
      <td id="${it.key}-premium">—</td>
    `;
    tableBody.appendChild(tr);
    // recalc when qty changes
    tr.querySelector("input").addEventListener("input", computeTotals);
  }

  // load prices.json and render
  async function loadAndRender(){
    try{
      const resp = await fetch("./prices.json", {cache: "no-store"});
      if(!resp.ok) throw new Error("HTTP " + resp.status);
      PRICE_DATA = await resp.json();
      renderRows();
      computeTotals();
    }catch(err){
      alert("Failed to load prices.json: " + err.message);
      console.error(err);
    }
  }

  function readUnitPrice(key){
    // prefer 24h average, else 7d average
    const rec = PRICE_DATA?.prices?.[key];
    if(!rec) return null;
    if(prefer === "24"){
      return (rec.avg24h != null) ? rec.avg24h : (rec.avg7d != null ? rec.avg7d : null);
    } else {
      return (rec.avg7d != null) ? rec.avg7d : (rec.avg24h != null ? rec.avg24h : null);
    }
  }

  function renderRows(){
    for(const it of ITEMS){
      const unitsCell = document.getElementById(it.key + "-units");
      const unitUsedCell = document.getElementById(it.key + "-unitUsed");
      const rec = PRICE_DATA?.prices?.[it.key];
      const u24 = rec?.avg24h ?? null;
      const u7 = rec?.avg7d ?? null;
      unitsCell.textContent = (u24 != null ? formatNum(u24) + " (24h)" : (u7 != null ? formatNum(u7) + " (7d)" : "—"));
      const used = readUnitPrice(it.key);
      unitUsedCell.textContent = used != null ? formatNum(used) : "N/A";
    }
  }

  function formatNum(n){
    if(n == null) return "—";
    return Number(n).toLocaleString();
  }

  function computeTotals(){
    let totalCost = 0;
    let totalPremium = 0;
    const toolsMarkup = Number(markupInput.value) / 100;

    for(const it of ITEMS){
      const qty = Number(document.getElementById(it.key + "-qty").value) || 0;
      const usedUnit = readUnitPrice(it.key);
      const costCell = document.getElementById(it.key + "-cost");
      const premiumCell = document.getElementById(it.key + "-premium");

      if(usedUnit == null || qty <= 0){
        costCell.textContent = "—";
        premiumCell.textContent = "—";
        continue;
      }

      // apply tools markup if this is a tool
      const unitAfterMarkup = (it.type === "tool") ? Math.round(usedUnit * (1 + toolsMarkup)) : usedUnit;

      // cost
      const cost = safeMul(unitAfterMarkup, qty);
      // premium equivalent: divide per rules (unitAfterMarkup / divisor) * qty
      const perUnitPremium = unitAfterMarkup / it.divisor;
      const premiumVal = perUnitPremium * qty;

      totalCost += cost;
      totalPremium += premiumVal;

      costCell.textContent = formatNum(cost);
      premiumCell.textContent = Number(premiumVal.toFixed(4)); // keep fractional premium precision
    }

    totalCostEl.textContent = formatNum(Math.round(totalCost));
    totalPremiumEl.textContent = Number(totalPremium.toFixed(4));
  }

  function safeMul(a,b){
    // digit-by-digit care as required by instructions (simple precise multiplication for integers)
    return Math.round(Number(a) * Number(b));
  }

  // initial load
  await loadAndRender();

})();
</script>
</body>
</html>
